# 第七章 NB-IoT与LoRa通信技术

## NB-IoT通信技术概述

​		蜂窝无线技术（Cellular Wireless Technology）是指通过基站来提供无线通信服务的一种网络架构。它是目前大多数移动通信网络（如2G、3G、4G和5G）使用的基础技术。在蜂窝网络中，整个覆盖区域被划分为多个小区域，即蜂窝，每个蜂窝内有一个基站负责无线通信。每个基站提供一个特定范围内的无线覆盖，并通过相互之间的协调来确保网络的连续性。NB-IoT是基于现有蜂窝无线技术的一种新型低功耗广域网（LPWAN）技术，由3GPP（第三代合作伙伴计划）定义，可直接部署于LTE（Long-Term Evolution, 长期演进技术）网络。

​		LTE网络是第四代移动通信技术（4G）的一种标准，主要用于高速数据传输和增强的移动网络性能。LTE是由3GPP制定的标准，旨在改进前代技术在数据速率、网络容量和延迟等方面的不足。

​		NB-IoT（窄带物联网）具备四大特点：

​		广覆盖：NB-IoT具备显著的广覆盖能力，在相同频段下，相比现有的移动通信技术，NB-IoT具有20dB增益，相当于提升了100倍的信号接收能力。这使得NB-IoT特别适合于传统蜂窝网络难以覆盖的区域，如地下车库，NB-IoT可通过外挂定位模块实现精准定位和导航，同时也可以跨区域构建停车指示系统。

​		大连接：NB-IoT支持每个小区高达5万个终端与核心网的连接，比现有蜂窝无线技术的接入能力提升了50至100倍。这种大连接能力使得NB-IoT非常适合应用于智能家居领域，每个家庭可以接入多达250个设备，满足大量设备联网的需求。

​		低功耗：NB-IoT通过引入多种低功耗技术，如节点模式（Power Saving Mode, PSM）和增强型非连续接收模式（Enhanced Discontinuous Reception, eDRX），使得设备在待机时能够减少不必要的信令交互，延长电池使用寿命。这使得NB-IoT终端模块能够长时间在线，在待机时可持续工作长达10年。

​		低成本：NB-IoT核心网相对于传统EPC（Evolved Packet Core, 演进分组核心）核心网，增加了小包数据控制面传输（Small Data Packet Control Plane Transmission）优化、节电优化以及简化信令流程等手段，大幅降低了网络建设和运营成本。由于NB-IoT芯片体积小，射频优化，且模块价格低廉，市场普遍预计单个NB-IoT模组的成本约为1美元。

## NB-IoT的关键技术

### 广覆盖技术

​		NB-IoT的系统带宽为200kHz，上下行有效传输带宽为180kHz，下行采用正交频分复用技术（Orthogonal Frequency Division Multiplexing, OFDM），将一个大的频带分成许多较窄的子频带，每个子频带（子载波）可以并行传输不同的数据流，这些子载波之间的相位和频率是经过精确设计的，因此可以保证它们相互之间不会干扰，从而提高数据的传输速率和抗干扰能力。

​		上行由两种传输方式：单载波传输（Single Carrier, SC）和多载波传输（Multi-Carrier Modulation, MCM），在单载波传输中，整个数据流通过一个载波进行调制，传输过程中没有分多路并行的子载波。在多载波传输中，数据被分为多个子流，并分别调制到不同的载波上，最终在频谱范围内同时传输。上行（Uplink）指的是从终端设备（如传感器）到网络（如基站）的数据传输，下行（Downlink）指的是从网络到终端设备的数据传输。

​		NB-IoT支持三种部署方式（在现有的LTE上部署NB-IoT），分别是独立部署（Stand Alone Operation）、保护频段部署（Guard Band Operation）和频段带内部署（In Band Operation），示意图如图7-1所示。

![image-20241116205550538](https://chuantaoli.oss-cn-beijing.aliyuncs.com/image-20241116205550538.png)

<center>
    图7-1 NB-IoT的三种部署方式
</center>

​		在独立部署中，利用现网的空闲频谱或者新的频谱进行部署，不与现行LTE网络或其他制式蜂窝网络在同一频段，不会形成干扰。独立频段的使用需要额外的频谱资源，意味着需要为NB-IoT分配新的频谱，这需要额外的资源成本。

​		在保护频段部署中，利用LTE边缘保护频段（Guard Band）中未使用的带宽资源块，最大化频谱资源利用率，单保护频段的带宽通常较窄，因此可用的频谱资源有限，可能不能满足大规模NB-IoT部署的需求。边缘保护频段通常是LTE系统的频谱边缘未使用的空白带，这些区域本来是为了避免相邻频段之间的干扰而预留的。

​		在频段内部署中，占用LTE的一个物理资源块（PhysicResource Block）资源来部署NB-IoT。在LTE网络中，数据传输是通过物理资源块来管理的，每个资源块包含一定的频带宽度和时隙。NB-IoT系统会利用现有LTE频段中的物理资源块，直接在这些资源块中传输NB-IoT的数据。

​		和GPRS（通用分组无线服务）相比，NB-IoT在下行信道上覆盖增强的增益主要来源于重复发送，即同一个控制消息或业务数据在空口信道上发送时，通过多次重复发送，用户终端在接收时，对接收到的重复内容进行合并，来提供覆盖能力。在上行方向上，NB-IoT 依赖功率谱密度增强（Power Spectrum  Density Boosting,  PSD Boosting）和时域重复（Time Domain Repetition, TDR）来获得比GPRS或LTE系统多20dB的覆盖增强。

​		功率谱密度是单位频带宽度上信号功率的大小，简单来说，它决定了信号的“强度”。NB-IoT通过增加每个符号的功率谱密度，使得信号能够在较远的距离内保持较好的接收质量。在时域重复中，NB-IoT终端会在多个时隙中发送相同的数据或控制信息。通过多次发送相同的内容，接收端可以从不同的接收副本中提取有效信息。这种方式有效地提高了数据的可靠性。

### 低功耗技术

​		NB-IoT在LTE系统的非连续接收（Discontinuous Reception, DRX）基础上进行了优化，采用功耗节省模式（Power Saving Mode, PSM）和增强型非连续接收（Enhanced Discontinuous Reception, eDRX）两种模式。PSM 是在 Idle 态（Inactive Data Link Exchange, 空闲态）下再新增加一个新的状态 PSM（Idle 的子状态），如图7-2所示。在该状态下，终端设备通过周期性地关闭其无线通信模块（如关闭接收功能）来节省电量。设备进入PSM后，不会再接收任何数据，直到设定的时间周期到达时才会唤醒并重新连接到网络。这使得设备在无需频繁通信的情况下，可以大幅减少天线、射频、信令处理等功耗。

![image-20241116213009284](https://chuantaoli.oss-cn-beijing.aliyuncs.com/image-20241116213009284.png)

<center>
    图7-2 PSM模式
</center>

​		eDRX（Extended Discontinues Reception, 增强型非连续接收）原理如图7-3所示，是 3GPP R13 （第三代合作伙伴计划第十三版）版本引入的技术，是对原DRX 技术的增强，主要原理为支持更长周期的寻呼监听，从而达到节电目的。DRX是一种节电技术，允许移动设备在不需要接收数据时进入睡眠模式，只有在核心网发起寻呼时才会唤醒设备进行数据接收。传统的DRX通常会设定一个固定的寻呼间隔，比如1.28/2.56s，即设备在这些间隔内会定期检查是否有下行数据需要接收。如果设备没有数据要接收，它会继续进入睡眠状态。eDRX 技术延长了设备的寻呼监听周期，即不再频繁唤醒设备来检查下行数据是否到达，而是根据业务需求和网络条件，允许设备跳过大部分寻呼监听。设备与核心网通过 attach（附着）和 TAU（跟踪区域更新）过程来协商eDRX的寻呼周期，可为 20 s、40 s、80 s，最长可以设置为 2.92小时。如果设备没有收到数据，它会在更长的时间间隔内处于休眠状态，节省电池能量。在下行数据发送频率较低的情况下，eDRX非常有效，因为设备不需要频繁检查网络，而只需要在关键时刻才被唤醒。

<img src="https://chuantaoli.oss-cn-beijing.aliyuncs.com/image-20241116213415176.png" alt="image-20241116213415176" style="zoom: 67%;" />

<center>
    图7-3 eDRX模式
</center>

### 大连接技术

​		相比于2G/3G/4G的通信系统，NB-IoT上行容量有50~100倍的提升，设计目标为每个小区5万连接数，大量终端处于休眠状态，其上下文信息由基站和核心网维持，一旦终端有数据发送，可以迅速进入连接状态。

### 低成本技术

​		NB-IoT的低速率、低带宽和低功耗特性带来的是终端低成本。低速率就味着芯片模组不需要大的缓存，低功耗意味着射频设计的要求可以降低；低带宽则不需要复杂的均衡算法，简化盲检次数，减小最大传输块，简化调制解调编码方式，直接去掉IP多媒体子系统（IP Multimedia Subsystem，IMS）协议栈，简化天线设计，相比LTE芯片来说，众多因素使得NB-IoT芯片设计简化，进而带来低成本优势。

​		NB-IoT主要设计用于传输小数据包、周期性数据和低速率的通信，目标是满足物联网设备的需求，而不是提供语音或视频等多媒体服务，因此可以去掉IMS协议栈。

## NB-IoT的网络体系

​		NB-IoT从LTE演变而来，继承了很多LTE的实现方式，但是与传统的LTE网络体系架构致力于给用户提高更高的带宽、更快的接入，以适应快速发展的移动互联网的需求不同，物联网应用具有UE（User Equipment, 用户设备）数量众多、功耗控制严格、小数据包通信、网络覆盖分散等特点，传统的LTE网络已无法满足物联网的实际发展需求。

​		演进的分组系统（Evolved Packet System, EPS）主要包括3个部分，分别是演进分组核心系统（Evolved Packet Core, EPC）、基站（eNodeB, eNB, E-UTRAN, 无线接入网）、UE用户终端（User Equipment, UE）。其中，UE是具体应用的终端实体，如搭载NB-IoT传输模块的水表，是整个网络体系中底层的业务实体。如图7-4所示，UE通过Uu接口（空中接口）接入E-UTRAN无线网中，无线接入网由多个eNB基站组成。接入网和核心网之间通过S1接口进行连接，该接口包括S1-MME和S1-U两种形式，其中S1-MME用于连接eNB和MME（移动性管理实体），S1-U用于连接eNB和服务网关（Serving Gateway, SGW）、分组数据网关（PDN Gateway, PGW）、业务能力开放单元（Service Capability Exposure Function, SCEF）。E-UTRAN无线网和EPC核心网在NB-IoT网络架构中承担着彼此相互独立的功能，两者之间相互连接。

![image-20241117185624015](https://chuantaoli.oss-cn-beijing.aliyuncs.com/image-20241117185624015.png)

<center>
    图7-4 演进的分组系统
</center>

​				EPC负责核心网部分，提供全IP连接的承载网络，主要包括移动性管理实体（MME），服务网关（SGW）、分组数据网关（PGW）、业务能力开放功能（SCEF）和归属地用户服务器（HSS）等，如图7-5所示。

![image-20241117195004698](https://chuantaoli.oss-cn-beijing.aliyuncs.com/image-20241117195004698.png)

<center>
    图7-5 NB-IoT核心网架构
</center>

​		MME是核心网的关键控制节点，主要负责信令处理部分，包括移动性管理、承载管理用户鉴权认证、SGW和PGW的选择等功能。MME同时支持在法律许可范围内的拦截和监听功能。MME引人了NB-IoT能力协商、附着时不建立PDN连接、创建Non-IP的PDN连接，支持 CP（控制面）模式、UP（用户面）模式，支持有限制性的移动性管理等。

​		SGW是终止于E-UTRAN接口的网关，该设备的主要功能包括：进行eNodeB 间切换时，可以作为本地锚定点，并协助完成eNodeB的重排序功能；执行合法侦听功能；进行数据包的路由和前转；在上行和下行传输层进行分组标记；空闲状态下，下行分组缓冲和发起网络触发的服务请求功能。

​		PGW是EPS的锚点，终结于外部数据网络（如因特网）的SGI接口，是面向PDN终结于SGI的网关，如果 UE 访问多个PDN，UE将对应一个或多个PGW。PGW的主要功能有：基于用户进行包过滤、合法侦听、UE的卫地址分配、在上/下行链路中进行数据包传输层标记、进行上/下行业务等级计费以及业务级门控、进行基于业务的上/下行速率的控制等。另外，PGW还提供上/下行链路承载绑定和上行链路绑定校验功能。

## IoT平台

​		从应用框架上，IoT平台处于终端设备与应用平台中间，起到桥接作用。NB-IoT设备终端接入到IoT平台，IoT平台对它们进行节点管理、接入管理、数据接收缓存等。同时，IoT 平台提供标准化API，方便与应用平台进行对接，可提供数据推送、异常告警、命令下发缓存等功能。通用IoT平台的出现，方便了整个NB-IoT应用解决方案的快速实现，从开发难度、功能性能、稳定性、可靠性等多方面提供了服务和保证。

## LoRa通信技术简介

### LoRa扩频技术

​		LoRa提供了一种基于扩频技术的超远距离无线传输方案，LoRa扩频技术改变了传输功耗和传输距离之间的平衡；LoRa 信号采用扩频技术发送，具有极强的抗干扰能力，信号比噪音弱100倍时也能检出；通过扩频编码，发送侧将信号的频带扩展了N倍，接收侧重新恢复信号时，通过扩频码的相关计算，信号强度增加N倍，但噪音没有变化，这样信噪比提升N倍，能够有效检出信号。

![image-20241117200032934](https://chuantaoli.oss-cn-beijing.aliyuncs.com/image-20241117200032934.png)

<center>
    图7-6 LoRa调制过程和信号传输
</center>

​		如图7-6所示，蓝色方块表示用户数据，通常是低速率的数字信息，比如传感器读取的数据。绿色方块代表扩频码，用于将原始数据调制成更宽带的信号。$⊕$表示将用户数据与扩频码进行异或运算，以将数据分布在较宽的频谱范围内。调制后生成的发送信号展示为粉红色的方块图，这些小方块称为码片。每个码片代表扩频码的一个元素。因为扩频过程，传输信号变得更宽频，但每个比特在传输中都有冗余，增强了信号的抗干扰能力。

### LoRa调制参数

​		LoRa调制解调器采用了扩频调制和前向纠错技术，可以通过调整扩频因子和纠错率实现在带宽占用、数据速率、链路预算改善以及抗干扰性之间的较好平衡。LoRa调制的基本参数有：扩频因子（Spreading Factor, SF）、编码率（Code Rate, CR）和带宽（Bandwidth, BW）。

​		扩频因子表示每个符号被分成多少个码片来进行传输。它控制每个符号的持续时间，取值范围通常是6至12，增大 SF 会增加符号持续时间，降低数据速率，但提高抗干扰和抗干扰能力。编码率表示前向纠错码的比例，用于在传输过程中增加冗余以抵抗错误。CR 的典型取值为4/5 4/6 4/7 4/8，表示每 5 到 8 个比特中有 4 个是数据，其余为纠错位。较低的CR提供更高的纠错能力，但数据速率会降低。较高的CR则减少纠错能力，但提高数据速率。带宽是信号占用的频谱宽度，常见的选项为125kHz、250kHz和500kHz。较大的BW会提高数据速率，但也会导致对外部噪声的更大敏感性。较小的BW提供更高的抗干扰性能，但降低数据速率。

​		一个符号的扩频周期$T_s$，单位为$s$，可表示为：
$$
T_s=\frac{2^{SF}}{BW}\tag{1}
$$
​		符号速率为：
$$
R_s=\frac{1}{T_s}=\frac{BW}{2^{SF}}\tag{2}
$$
​		码片速率为：
$$
R_c=R_s\times 2^{SF}=BW\tag{3}
$$
​		调制后的数据速率表示为：
$$
R_b=SF\times \frac{BW}{2^{SF}}\tag{4}
$$

### LoRaWAN

​		LoRaWAN设计了一套LoRa MAC协议，包括ClassA，B，C三个子选项，分别对应三种终端类型：低功耗、功耗响应折中和实时响应，适用于不同应用场景，如图7-7所示。

<img src="https://chuantaoli.oss-cn-beijing.aliyuncs.com/image-20241117200420783.png" alt="image-20241117200420783" style="zoom:50%;" />

<center>
    图7-7 LoRa MAC协议
</center>

​		LoRaWAN使用远程星形架构。其中网关用于在终端设备和中央核心网络之间中继消息。在LoRaWAN网络中，节点不与特定网关关联。如图7-8所示。

<img src="https://chuantaoli.oss-cn-beijing.aliyuncs.com/image-20241117200604721.png" alt="image-20241117200604721" style="zoom:50%;" />

<center>
    图7-8 LoRaWAN架构
</center>

​		End Nodes（终端节点）：包括物理层、MAC层和应用层的实现，使用LoRa线性扩频调制技术，遵守LoRaWAN协议规范，实现点对点远距离传输。Gateway/Concentrator （网关/集中器）：完成空中接口物理层的处理。网关负责接收终端节点的上行链路数据，然后将数据聚集到一个各自单独的回程连接，解决多路数据并发问题，实现数据收集和转发。终端设备采用单跳与一个或多个网关通信，所有的节点均是双向通信。网关和网络服务器通过以太网回传或任何无线通信技术（如3G、4G、5G）建立通信链路，使用标准的TCP/IP连接。Network Server（网络服务器）：负责进行MAC层处理，包括消除重复的数据包、自适应速率选择、网关管理和选择、进程确认、安全管理等。Application Server（应用服务器）：从网络服务器获取应用数据，管理数据负载的安全性，分析及利用传感器数据，进行应用状态展示、即时警告等。

## LoRa和NB-IOT的比较

​		自由度方面：对客户而言，使用NB-IoT主要依赖于运营商的基础网络设施，在很多条件恶劣的地方，运营商的基础设施并没有完全覆盖。而LoRa是一个更灵活的自主网络，在任何需要的地方，都可以进行部署，企业（甚至个人）也能成为“运营商”。

​		安全性方面：NB-IoT是运营商网络，因此数据是先传到运营商的， 许多企业不愿意把自己的数据给到别人，所以这些企业会选择部署自己的私有LoRa网络。

​		频段方面：LoRa工作在1GHz以下的非授权频段（中国主要使用470-518MHz），无需申请即可进行网络的建设，故在应用时不需要额外支付通讯费用。

| 参数             | NB-IoT             | LoRa              |
| ---------------- | ------------------ | ----------------- |
| 技术特点         | 蜂窝               | 线性扩频          |
| 网络部署         | 与现有蜂窝基站复用 | 独立建网          |
| 频段             | 运营商频段         | 150 MHz 到 1 GHz  |
| 传输距离         | 远距离             | 远距离（1-20 km） |
| 速率             | <100 kbps          | 0.3-50 kbps       |
| 连接数量         | 200k/cell          | 200k-300k/hub     |
| 终端电池工作时间 | 约 10 年           | 约 10 年          |
| 成本             | 模块 \$5-\$10      | 模块约 $5         |